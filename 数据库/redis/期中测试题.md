##### Redis 的 Streams 数据类型可以用来实现消息队列，关于 Streams，下列哪个描述是不正确的？

- Streams可以为消息自动生成全局唯一id
- Streams会自动留存消息，直到消费者使用XACK确认后，再删除消息
- Streams支持阻塞式消息读取
- Streams提供的消费组模式，同一个消费组内的消费者可以同时消费同一条消息

```
答案：D
题目解析
选项 D，同一条消息在同一个消费组内只能被一个消费者读取消费
```



##### 在 Redis 运行的过程中，运维人员通过 info memory 命令，查看到mem_fragmentation_ratio 的值等于 2，此时，Redis 的内存使用情况是怎样的？

- 内存使用中存在较为严重的内存碎片
- 内存空间不够，可能已经发生了 swap
- 内存使用正常，有少量内存碎片
- 内存非常充足，可以保存更多的数据

```
答案：A
题目解析
选项 A，正确

选项 B，选项描述的情况对应于 mem_fragmentation_ratio 的值小于 1 的场景

选项 C，一般 mem_fragmentation_ratio 大于 1.5 时，内存碎片就比较严重了

选项 D，无法判断内存是否充足，但是碎片已经较为严重了
```



##### 在 Redis 中，默认的内存分配器使用的是 jemalloc，当 Redis 想要分配 23 字节的空间时，jemalloc 实际会分配多大空间？

- 23
- 24
- 32
- 64

```
答案：C
题目解析
jemalloc 在分配内存时，是按照一系列固定的大小进行分配，而不是按需分配，和 23 字节最接近的固定大小是 32 字节，所以本题答案是 C
```



##### Redis 使用 RDB 机制创建快照，关于 RDB 机制，下面的描述哪个是错误的？

- 使用 save 命令生成 RDB 快照时，是在主线程中执行的，会阻塞主线程
- RDB 文件是 Redis 实例的镜像，用 RDB 文件恢复实例时，直接把 RDB 文件加载到内存，就可以快速恢复了
- 和 AOF 文件相比，RDB 文件更小一点
- 使用 bgsave 命令创建 RDB 快照时，主线程只能处理读请求，写请求操作会被阻塞

```
答案：D
题目解析
选项 A、B、C 描述正确

选项 D，bgsave 创建快照时，主线程能同时处理读写请求
```



##### Redis 使用 AOF 机制保存数据操作时，可以采用不同的写回策略。当需要有一定的数据可靠性，同时也不能对 Redis 实例造成较大阻塞的话，应该选择以下哪种写回策略？

- always
- everysec
- no
- yes

```
答案：B
题目解析
选项 A，可靠性高，但会阻塞 Redis 实例

选项 B，正确

选项 C，基本不会阻塞 Redis 实例，但是宕机后，会丢失较多的日志记录

选项 D，写回策略没有 yes 配置项
```



##### 现在，有一个 Redis 实例正在线上运行，它使用 Hash 类型保存了一个 key 为 device 的 Hash 集合，集合中保存了 500 万条记录。在这些记录中，有 20 万条记录的 key 是以“redis”开头的，现在想把这些记录读取出来，应该采用以下哪些命令?

- KEYS
- SCAN
- HSCAN
- SSCAN

```
答案：C
题目解析
选项 A，KEYS 会引起 Redis 实例阻塞，而且 KEYS 无法查询 Hash 集合中的记录

选项 B，SCAN 只能查询整个数据库中的 key

选项 C，正确

选项 D，SSCAN 是用来扫描查询 Set 类型
```



##### 在主从集群中，当主库收到从库发送的 psync ? -1 命令时，从库希望主库执行的操作是以下哪一项？

- 进行增量复制
- 结束数据复制操作
- 断开网络连接
- 进行全量复制

```
答案：D
题目解析
选项 A，增量复制时，从库会把自己记录的主库 ID 发给主库，所以 psync 命令会带有主库 ID

选项 B，不会发送 psync 命令

选项 C，不会发送 psync 命令

选项 D，正确
```



##### 关于哨兵机制，下面的哪个描述是正确的？

- 哨兵是一个运行在特定模式下的 Redis 实例，也可以服务请求
- 哨兵提供 pub/sub 功能
- 哨兵只通过心跳监听主库的运行状态
- down-after-milliseconds 是哨兵用来判断主库客观下线的心跳断连阈值

```
答案：B
题目解析
选项 A，哨兵不服务请求

选项 B，正确

选项 C，哨兵同时监听从库的运行状态

选项 D，down-after-milliseconds 是主观下线的判断依据
```



在使用哨兵机制对发生故障的主从集群进行主从库切换时，会涉及：

-  （1）主库被判断为主观下线；
-  （2）主库被判断为客观下线；
-  （3）确定新主库；
-  （4）选举哨兵 Leader；
-  （5）主从库实际切换。

#####  关于这些事件的发生顺序，以下哪个选项的描述是正确的？

- (1)->(2)->(3)->(4)->(5)
- (2)->(1)->(3)->(4)->(5)
- (1)->(2)->(4)->(3)->(5)
- (2)->(1)->(4)->(3)->(5)

```
答案：C
题目解析
主库的主观下线只用哨兵自己判断就行，而客观下线需要多个哨兵共同决定，所以判断主库主观下线要早于判断客观下线。


主从库切换时，新主库是由哨兵 Leader 来确定的，所以，哨兵集群需要先选出 Leader，再确定新主库。
```



##### 在一个由 5 个哨兵组成的哨兵集群中，配置文件中的 quorum 值配置为 4，那么，当有哨兵发现主节点故障，开始进行 Leader 选举时，这个哨兵需要获得几张赞成票，才能成功地成为 Leader？

- 2
- 3
- 4
- 5

```
答案：C
题目解析
哨兵 Leader 选举需要满足两个条件：一是要拿到半数以上的赞成票；二是，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值，本题中的 quorum 值设为 4，所以至少要获得 4 张赞成票。
```



##### 在使用 Redis Cluster 时，如果客户端发送操作请求后，收到了 MOVED 命令，此时，Redis Cluster 发生了以下哪种情况?

- 请求的数据在 Cluster 中已经被删除
- 请求数据所在的哈希槽正在往其他实例迁移
- 请求数据所在的哈希槽已经迁移到了其他实例
- 请求的数据正在持久化保存

```
答案：C
题目解析
A 选项，此时返回 nil 值

B 选项，此时返回 ASK 报错信息

C 选项，正确

D 选项，不会报错，可以正常返回结果
```



##### 在 Redis 的诸多数据类型中，以下哪种数据类型允许插入重复的元素？

- HyperLogLog
- List
- Set
- Sorted Set

```
答案：B
题目解析
选项 A，会对元素去重

选项 B，正确，允许写入重复元素

选项 C，会对元素去重

选项 D，会对元素去重
```



##### Redis 数据库是将下列哪种数据结构作为全局数据结构，来保存每一对键值对？

- 数组
- 哈希表
- 跳表
- 双向链表

```
答案：B
题目解析
题目问的是 Redis 数据库的全局数据结构，所以选 B。其他选项是 Redis 某一个数据类型的底层数据结构
```



##### 在 Redis 的主从库集群中，如果主库宕机了，以下哪个机制可以让 Redis 实现自动的主从库切换？

- AOF 重写机制
- RDB 机制
- 切片机制
- 哨兵机制

```
答对啦
答案：D
题目解析
A 选项，AOF 重写用来精简过大的 AOF 文件，加速 Redis 实例恢复。

B 选项，RDB 机制用来生成快照，用于实例恢复或是主从库复制。

C 选项，切片机制是把数据分散到多个实例保存，用于保存大量数据。

D 选项，正确。
```



##### 以下哪个功能是由 Redis 主线程完成的？

- 键值对读写
- UNLINK 操作
- 生成 RDB 快照
- AOF 重写

```
答案：A
题目解析
A 选项，正确。

B 选项，UNLINK 操作是 Redis 4.0 后提供的后台异步删除操作，由后台子线程完成。

C 选项，RDB 生成是主线程通过 fork 创建了子进程来完成的。

D 选项，AOF 重写也是由主线程通过 fork 创建了子进程来完成的。
```



##### 以下哪些情况会引起 Redis 的主线程阻塞？

- Redis 3.0 中， 删除一个100万元素的 Set 集
- AOF 写回策略配置为 everysec，同时 no-appendfsync-on-rewrite 设置为 no
- 200 万个键值对同时过期
- 一个服务读为主负载的 Redis 实例， 已保存的数据量为 1GB，正在创建 RDB 快照

```
答案：ABC
题目解析
选项 A，会引起阻塞，Redis 3.0 时还没有异步删除机制

选项 B，AOF 重写和 AOF 写回会竞争磁盘 IO 资源，导致 AOF 写回被阻塞，进而导致主线程也被阻塞

选项 C，大量键值对同时过期会引发主线程阻塞

选项 D，RDB 由子进程生成，而且实例服务的是读为主的负载，没有内存的 COW 压力，不会阻塞
```



##### RDB 和 AOF 是 Redis 使用的两种持久化机制，关于这两种机制，下面的哪些描述是正确的？

- 使用 RDB 进行实例恢复的速度，要比使用 AOF进行恢复的速度快
- RDB 的生成和 AOF 的日志记录都是通过子进程来完成的
- AOF 文件记录的操作日志过多时，为了避免文件过大，需要手动删除失效的操作日志
- Redis 4.0 版本中可以使用 RDB 做快照，同时使用 AOF 记录两次快照间的操作日志

```
答案：AD
题目解析
选项 A，正确

选项 B，AOF 日志记录是由主线程完成的

选项 C，AOF 重写机制可以自动清理 AOF 文件，不用手动清理

选项 D，正确
```



##### 我们可以使用 Hash 和 Sorted Set 组合来保存时间序列数据，以下哪些功能可以使用这种方式直接在 Redis 实例上完成？

- 计算某个时间范围内的数据最大值
- 查询某个时刻的数据
- 查询某个时间范围内的所有数据
- 查询最新时刻的数据

```
答案：BCD
题目解析
选项 A，无法直接在 Redis 实例上完成，需要把数据读取到客户端，然后再进行计算

选项 B，正确

选项 C，正确

选项 D，正确
```



##### Redis 的 Hash 数据类型，是采用以下哪两种结构作为它的底层实现的？

- 整数数组
- 双向链表
- 哈希表
- 压缩列表

```
答案：CD
题目解析
A 选项，是 Set 类型的底层结构

B 选项，是 List 类型的底层结构

C 选项，正确

D 选项，正确
```



##### 关于 Redis Cluster， 下面哪个描述是正确的？

- Redis Cluster 一共有16384 个哈希槽
- 使用 Redis Cluster 时，客户端不用记录哈希槽的任何信息，可以直接通过哈希计算，确定键值对在哪个实例
- Redis Cluster 属于可扩展集群，主要用途是让Redis 数据库能够保存更多数据
- Redis Cluster 中的实例只能通过持久化机制进行可靠性保证

```
答案：AC
题目解析
A 选项，正确

B 选项，客户端需要缓存哈希槽和实例的对应关系，无法直接通过哈希计算就知道数据在哪个实例，只能知道在哪个哈希槽

C 选项，正确

D 选项，Redis Cluster 的实例也可以配置主从节点，进行可靠性保证
```





##### Redis 在接收多个网络客户端发送的请求操作时，如果有一个客户端和 Redis 的网络连接断开了，Redis 会一直等待该客户端恢复连接吗？为什么？

Redis 不会等待客户端恢复连接。

原因是，Redis 的网络连接是由操作系统进行处理的，操作系统内核负责监听网络连接套接字上的连接请求或数据请求，而 Redis 采用了 IO 多路复用机制 epoll，不会阻塞在某一个特定的套接字上。epoll 机制监测到套接字上有请求到达时，就会触发相应的事件，并把事件放到一个队列中，Redis 就会对这个事件队列中的事件进行处理。这样一来，Redis 只用查看和处理事件队列，就可以了。当客户端网络连接断开或恢复时，操作系统会进行处理，并且在客户端能再次发送请求时，把接收到的请求以事件形式通知 Redis。



##### Redis 的主从集群可以提升数据可靠性，主节点在和从节点进行数据同步时，会使用两个缓冲区：复制缓冲区和复制积压缓冲区。这两个缓冲区的作用各是什么？会对 Redis 主从同步产生什么影响吗？

首先来说一下复制缓冲区。

**作用：**主节点开始和一个从节点进行全量同步时，会为从节点创建一个输出缓冲区，这个缓冲区就是复制缓冲区。当主节点向从节点发送 RDB 文件时，如果又接收到了写命令操作，就会把它们暂存在复制缓冲区中。等 RDB 文件传输完成，并且在从节点加载完成后，主节点再把复制缓冲区中的写命令发给从节点，进行同步。对

**主从同步的影响：**如果主库传输 RDB 文件以及从库加载 RDB 文件耗时长，同时主库接收的写命令操作较多，就会导致复制缓冲区被写满而溢出。一旦溢出，主库就会关闭和从库的网络连接，重新开始全量同步。所以，我们可以通过调整 client-output-buffer-limit slave 这个配置项，来增加复制缓冲区的大小，以免复制缓冲区溢出。

再来看看复制积压缓冲区。

**作用：**主节点和从节点进行常规同步时，会把写命令也暂存在复制积压缓冲区中。如果从节点和主节点间发生了网络断连，等从节点再次连接后，可以从复制积压缓冲区中同步尚未复制的命令操作。

**对主从同步的影响**：如果从节点和主节点间的网络断连时间过长，复制积压缓冲区可能被新写入的命令覆盖。此时，从节点就没有办法和主节点进行增量复制了，而是只能进行全量复制。针对这个问题，应对的方法是调大复制积压缓冲区的大小（可以参考第 6 讲中对 repl_backlog_size 的设置）。





假设在业务场景中，我们有 20GB 的短视频属性信息（包括短视频 ID、短视频基本信息，例如短视频作者、创建时间等）要持久化保存，并且线上负载以读为主，需要能快速查询到这些短视频信息。

现在，针对这个需求，我们想使用 Redis 来解决，请你来设计一个解决方案。我来提几个问题，你可以思考下。

首先，你会用 Redis 的什么数据类型来保存数据？如果我们只用单个实例来运行的话，你会采用什么样的持久化方案来保证数据的可靠性？

另外，如果不使用单实例运行，我们有两个备选方案：一个是用两台 32GB 内存的云主机来运行主从两个 Redis 实例；另一个是用 10 台 8GB 的云主机来运行 Redis Cluster，每两台云主机分别运行一个 Redis 实例主库和从库，分别保存 4GB 数据，你会用哪种方案呢？请聊一聊你的想法。



##### 答案：

Redis 的 Hash 类型属于典型的集合类型，可以保存 key-value 形式的数据。而且，当 Hash 类型中保存较多数据时，它的底层是由哈希表实现的。哈希表的存取复杂度是 O(1)，所以可以实现快速访问。在这道题中，短视频属性信息属于典型 key-value 形式，所以，我们可以使用 Hash 类型保存短视频信息。具体来说，就是将一个短视频 ID 作为 Hash 集合的 key，将短视频的其他属性信息作为 Hash 集合内部的键值对，例如“作者”:“实际姓名”，“创建时间”:“实际时间”。这样既满足了保存数据的需求，也可以利用 Hash 快速查询的特点，快速查到相应的信息。

Redis 的 AOF 日志会记录客户端发送给实例的每一次写操作命令，在 Redis 实例恢复时，可以通过重新运行 AOF 文件中的命令，实现恢复数据的目的。在这道题的业务场景中，负载以读为主，因此，写命令不会太多，AOF 日志文件的体量不会太大，即使实例故障了，也可以快速完成恢复。所以，当使用单实例运行时，我们可以使用 AOF 日志来做持久化方案。

关于使用多实例的运行方案：两种方案各有优势，我们来分析一下。

##### 方案一

优势：可以节省云主机数量和成本。虽然主从节点进行第一次全量同步时，RDB 文件较大，耗时会长些，但是因为写请求少，所以复制缓冲区的压力不大。不足：如果网络环境不好，需要频繁地进行全量同步的话，这种方案的优势就小了，每次全量同步时的 RDB 生成和传输压力都很大。

##### 方案二

优势：每个实例只用保存 4GB 数据，和从库同步时的压力较小。而且，这种方案的可扩展性更好，如果有新增数据，可以更好地应对。不足：需要较多的云主机，运维和资源成本较高。