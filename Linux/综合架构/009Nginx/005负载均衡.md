##### 什么是集群？

完成相同任务或工作的一组服务器



##### 什么是负载均衡？

- 实现用户访问请求进行调度分配
- 实现用户访问压力分担



##### 什么是代理？

- 反向代理：
  - 外网访问服务器首先访问的是代理服务器，经过代理服务器后才访问服务器
- 正向代理
  - 访问外网首先经过代理服务器然后再访问外网（翻墙）



##### 集群作用

- 高性能
- 价格有效性
- 可伸缩性
- 高可用性



##### web集群服务器部署

集群中每台服务器的配置一摸一样

- 先部署好一台服务器，上传代码信息
- 进行访问测试
- 批量部署多台web服务器
- 将nginx配置文件进行分发
- 将站点目录分发给所有主机





##### 如何让所有的web服务器和数据库服务器建立关系？

- 第一个历程：将web服务器本地数据库数据进行备份

  ```
  mysqldump -uroot -ppassword --all-databases >/tmp/web_back.sql
  ```

- 第二个历程：将备份数据进行迁移

  ```
  rsync -avz /tmp/web_back.sql 目标ip:/tmp 
  ```

- 恢复数据

  ```
  mysql -uroot -ppassword </tmp/web_back.sql
  ```

- 修改数据库服务器中数据库用户信息

  - 优化：输入无用的用户信息

    ```
    delete from mysql.user where user="";
    ```

  - 修改权限，让web服务器可以连接到数据库服务器

    ```
    grant all on wordpress.* to 'wordpress'@'172.16.1.%' identified by '密码';
    flush privileges;
    
    %:任意数字
    ```

- web服务器连接测试

  ```
  mysql -uwordpress -ppassword -h 数据库服务器ip
  ```

- 修改web服务器代码

  ```
  vim wp-config.php
  
  define('DB_HOST','数据库服务器ip')
  ```

- 停止web服务器数据库服务





##### 负载均衡服务器部署

- 第一个历程：安装nginx服务

- 第二个历程：编写nginx负载服务配置文件

  - ngx_http_upstream_module——upstream 负载均衡
  - ngx_http_proxy_module——proxy_pass 反向代理

  ```
  cd /etc/nginx
  cp nginx.conf{,.bak}
  useradd www -u 1002 -s /sbin/nologin -M
  
  vim nginx.conf
  user www;
  group www;
  
  cd conf.d/
  #新建lb.conf并将default.conf里面的内容复制一份到其中，排除了空行和注释的行
  grep -Ev '^$|#' default.conf >lb.conf
  
  vim lb.conf
  
  #定义可以将请求分配给哪些web服务器
  upstream oldboy {
  	server 10.0.0.7:80;
  	server 10.0.0.8:80;
  	server 10.0.0.9:80;
  }
  #将请求分配给指定的集群
  server {
  	listen 80;
  	server_name www.old.com;  #对这个网站进行负载均衡
  	location \ {
  		proxy_pass http://oldboy;
  	}
  }
  
  
  #upstream后面定义的名字要跟下面的proxy_pass后面的一样
  ```

- 实现负载功能测试

  - 搭建集群测试环境

    ```
    for name in www bbs blog;do echo "$name 10.0.07" >/html/$name/test.html;done
    
    for name in www bbs blog;do echo "$name 10.0.08" >/html/$name/test.html;done
    
    for name in www bbs blog;do echo "$name 10.0.09" >/html/$name/test.html;done
    ```

  - 修改host解析文件，删除之前每台web服务器做的相同的解析

    ```
    负载均衡服务器的ip 域名
    ```

  - 访问网址进行测试

  - 客户请求流程

    1、请求域名

    2、转负载均衡服务器

    3、将请求转web服务器

    4、请求结果转负载均衡服务器

    5、负载均衡服务器将结果再转给客户



负载均衡访问网站异常排错思路

- 测试后端web节点服务器是否能正常访问 （测试web服务器）

  ```
  curl -H host:www.old.com 10.0.0.7/wenwen.html
  curl -H host:www.old.com 10.0.0.8/wenwen.html
  curl -H host:www.old.com 10.0.0.9/wenwen.html
  
  相当于hosts文件解析
  10.0.0.7 www.old.com
  并访问www.old.com/wenwen.html
  
  就不用每一台主机进行修改hosts解析文件
  ```

  

- 利用curl命令访问负载均衡服务器（测试负载均衡服务器）

  ```
  curl 网址
  
  查看两个配置文件是否正确
  nginx.conf和负载均衡配置文件
  ```

- ping进行测试（测试客户端）

- 配置文件不正确





#### 负载均衡配置模块详细说明

##### ngx_http_upstream_module --- upstream

实现不同调度功能