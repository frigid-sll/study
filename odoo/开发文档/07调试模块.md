##### 自动重载和`--dev` 选项

在前面的章节中，我们学习了如何添加模型、字段和视图。每当对Python文件进行修改时，我们需要重启服务来应用这些修改。

如果我们对XML文件做出修改的话，需要重启服务并更新模块来在用户界面中反映这些修改。

如果你在开发一个大型应用的话，这会非常耗时且令人沮丧。

Odoo提供了一个命令行选项–dev来处理这些问题。`--dev`有一些可选值，本节中，我们就来学习如何使用它们。



运行如下shell命令来在开发环境中安装inotify。没有inotify，就无法运行自动重载的功能：

```
pip install inotify
```



##### 如何实现…

要启用dev选项，我们需要在命令行中使用`--dev=value`。这一选项可以使用的值有all、reload、 pudb|wdb|ipdb|pdb、 qweb、 werkzeug和xml。

- 查看如下示例来获取更多信息：

  ```
  odoo/odoo-bin -c ~/odoo-dev/my-instance.cfg --dev=all
  ```

- 如果你只想启用几个选项的话，可以使用逗号分隔的值，如下：

  ```
  odoo/odoo-bin -c ~/odoo-dev/my-instance.cfg --dev=reload,qweb
  ```



##### 运行原理…

查看如下列表来了解所有`--dev`选项及其用途：

- reload：无论何时对Python做出修改，我们需要重启该服务来在Odoo中应用这些修改。`--dev=reload`选项会在Python做出修改时自动重载Odoo服务。如未安装Python的inotify包则无法使用这一功能。此时使用这一选项运行Odoo服务时，会看到这样的日志：’inotify’ module not installed. Code autoreload feature is disabled
- qweb：我们可以在Odoo中使用QWeb模板来创建动态网页。在[第十四章 CMS网站开发](https://alanhou.org/odoo-14-cms-website-development/)中我们将了解如何使用QWeb模板开发网页。可以通过t-debug 属性在QWeb模板中调试问题。t-debug选项仅在你通过 `--dev=qweb`启用dev模式时才会生效。
- werkzeug：Odoo 使用werkzeug来处理HTTP请求。Odoo内部会捕获并控制所有由werkzeug生成的异常。如果使用`--dev=werkzeug`，werkzeug的交互式调试器会在生成异常时在网页中展示。
- xml：每当你在视图结构中做出更改时，都需要重新加载服务并更新模型来应用这些更改。通过`--dev=xml`选项，仅需在浏览器中重载Odoo，无需再重启服务或更新模块。
- pudb|wdb|ipdb|pdb：我们可以通过Python调试器（PDB）来获取错误的更多详情。在使用`--dev=pdb`选项时，它会在Odoo中产生异常时启动PDB。Odoo支持4种Python调试器：pudb, wdb, ipdb和pdb。
- all：如果使用`--dev=all`，会启用上述的所有选项。

> 📝重要：如果对数据库结构做出修改，比如添加了新字段， `--dev=reload`不会在数据库schema中进行反映。需要手动更新模块，它仅用于Python的业务逻辑。
>
> 如果你添加了一个视图或菜单，`--dev=xml`也不会在用户界面中进行反映。需要手动更新模块。在设计视图结构或网页时这会很有帮助。如果用户通过 GUI 在视图中作出修改，那么`--dev=xml`不会从文件中加载XML，Odoo会使用所修改的视图结构。



##### 产生服务日志来帮助调试方法

服务日志对于了解崩溃前运行时发生了什么会很有用。也可以添加日志来在调试问题时提供更多的信息。本节展示如何向已有方法添加日志。

我们会向如下方法添加一些日志语句，它会将产品的仓储级别保存到一个文件中（读者需要在声明文件中添加product和stock模块的依赖）

执行如下步骤在来执行方法时获取一些日志：

- 在代码的起始处，导入logging模块

  ```python
  import logging
  ```

- 在定义模型类之前，为模块获取一个日志记录器

  ```python
  _logger = logging.getLogger(__name__)
  ```

- 修改export_stock_level()的代码`models/product.py`，不要忘记在`models/__init__.py`中导入

  ```python
  from os.path import join
  from odoo import models, exceptions, api
  import logging
  
  EXPORT_DIR = '/srv/exports'
  _logger = logging.getLogger(__name__)
  
  
  class ProductProduct(models.Model):
      _inherit = 'product.product'
  
      @api.model
      def export_stock_level(self, stock_location):
          _logger.info('export stock level for %s', stock_location.name)
          products = self.with_context(
              location=stock_location.id
          ).search([])
          products = products.filtered('qty_available')
          _logger.debug('%d products in the location', len(products))
          fname = join(EXPORT_DIR, 'stock_level.txt')
          try:
              with open(fname, 'w') as fobj:
                  for prod in products:
                      fobj.write('%s\t%f\n' %(prod.name, prod.qty_available))
          except IOError:
              _logger.exception('Error while writing to %s in %s', 'stock_level.txt', EXPORT_DIR)
              raise exceptions.UserError('unable to save file')
  ```

  

##### 运行原理…

第1步从Python标准库中导入了logging模块。Odoo使用这一模块来管理它的日志。

第2步为Python模块设置了一个日志记录器。我们使用了一个Odoo中常用的 `__name__`来作为日志记录器名称的自动变量，并通过_logger调用。

> 📝**重要：**__name__变量由Python解释器在模块导入的时候自动设置，它的名称为模块的全名。因Odoo在导入时做了一些小动作，插件模块被Python视作属于odoo.addons Python包。因此，如果本节的代码放在 my_library/models/book.py中，__name__为odoo.addons.my_library.models.book。

这么做有两个好处：

- odoo日志记录器的全局日志配置会应用到我们日志记录器中，这源于logging模块中日志记录器的层级结构。
- 日志会以完整的模块路径为前缀，这对查找所产生日志的具体代码行会有很大帮助。

第3步中使用日志记录器来生成日志信息。可以使用的方法有（日志级别逐渐升高）：debug, info, warning, error和critical。所有这些方法接收一条消息，在其中可以使用%替换符及其它插入到消息中的参数。不应自己进行%替换，在生成日志时logging会足够智能地执行此操作。如果所运行的日志级别为INFO，那么DEBUG日志会避免具有长期CPU开销的替换。

本节中展示的另一个有用的方法是_logger.exception()，它可以在异常处理器中使用。消息会通过ERROR级别进行日志记录，栈的踪迹也会在应用日志中打印。



##### 扩展知识…

可以通过命令行或配置文件来控制应用的日志级别。这么做有两种主要方式：

第一种方式是使用`--log-handler`选项。基础语法为：`--log-handler=prefix:level`。此时前缀为日志记录器名称的一段路径，级别为DEBUG, INFO, WARNING, ERROR或CRITICAL。如果省去了前缀，则对所有记录器设置默认级别。例如，设置my_library日志记录器的日志级别为DEBUG并让其它插件保持默认日志级别，可以通过如下命令启动Odoo：

```
python odoo.py --log-handler=odoo.addons.my_library:DEBUG
```

可在命令行中多次指定`--log-handler`。也可以在Odoo实例的配置文件中配置日志处理器。那样的话，可以使用**前缀:日志级别**键值对组成的逗号分隔列表。例如，下面的这行配置和此前最小化日志输出的配置相同。默认我们保留最重要的消息及错误消息，例外情况是：werkzeug产生的消息我们仅需要紧急(critical)消息，还有odoo.service.server我们保留包含服务启动消息等信息级别的消息。

```
log_handler = :ERROR,werkzeug:CRITICAL,odoo.service.server:INFO
```



第二种方式是使用`--log-level`选项。要全局控制日志级别，可以使用`--log-level`来作为命令行选项。该选项可用的值有critical, error, warn, debug, debug_rpc, debug_rpc_answer, debug_sql和 test。

一些设置日志级别的快捷方式列出如下：

- `--log-request` 是`--log-handler=odoo.http.rpc.request:DEBUG`的简写
- `--log-response`是`--log-handler=odoo.http.rpc.response:DEBUG`的简写
- `--log-web`是`--log-handler=odoo.http:DEBUG`的简写
- `--log-sql`是`--log-handler=odoo.sql_db:DEBUG`的简写