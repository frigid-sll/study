##### 定义模型表示及排序

- 模型中有结构性属性来定义它们的行为。这些以下划线作为前缀。最重要的属性是`_name`，因为这定义了内部全局标识符。

- Odoo内部通过这一`_name`属性来创建数据表。
  - 例如，如果你使用`_name`=”library.book”，那么Odoo ORM会在数据库中创建一张library_book数据表。
  - 这也是为什么`_name`必须在Odoo系统中要保持唯一。

在模型中可以使用另外两个属性：

- **_rec_name** 是一个设置用于展示或记录标题的字段
- 另一个是**_order**, 用于设置记录的展现的顺序。



##### 如何实现

my_library实例应包含一个名为models/library_book.py的Python文件，它定义了一个基础模型。我们将编辑该文件来在_name之后添加一个新的类级属性：

- 加入如下代码来添加一个用户友好的模型标题

  ```
  _description = 'Library Book'
  ```

- 首先对记录进行排序（按时间最近排序，然后按标题排序），添加如下代码

  ```
  _order = 'date_release desc, name'
  ```

  - desc：降序
  - asc：升序

- 添加如下代码来使用short_name字段作为记录的表示

  ```
  _rec_name = 'short_name'
  short_name = fields.Char('Short Title', required=True)
  ```

- 在表单视图中添加short_name字段，这样会在该视图中显示这一新字段

  ```
  <field name="short_name"/>
  ```

- 完成如上操作之后，我们library_book.py文件应该是下面这样

  ```python
  from odoo import models, fields
  class LibraryBook(models.Model):
      _name = 'library.book'
      _description = 'Library Book'
      _order = 'date_release desc, name'
      _rec_name = 'short_name'
      name = fields.Char('Title', required=True)
      short_name = fields.Char('Short Title', required=True)
      date_release = fields.Date('Release Date')
      author_ids = fields.Many2many('res.partner', string='Authors')
  ```

- 你的library_book.xml 文件中的`<form>`视图应该是下面这样的

  ```xml
  <form>
      <group>
          <group>
              <field name="name"/>
              <field name="author_ids" widget="many2many_tags"/>
          </group>
          <group>
              <field name="short_name"/>
              <field name="date_release"/>
          </group>
      </group>
  </form>
  ```

- 我们应升级模块在让这些修改在Odoo中生效。升级模块，可以打开Apps菜单，搜索my_library模块，然后通过下拉菜单更新模块，如下图所示

  ![image-20230227161938474](/Users/pert/Library/Application Support/typora-user-images/image-20230227161938474.png)

- 更新模块的选项

  我们也可以通过在命令行中使用-u my_library来完成模块的升级。

  

##### 运行原理…

- 第一步为定义的模型添加了对用户更友好的标题。这并非强制的，但可以为一些插件所用。
  - 例如，它可在创建记录时用于mail插件模块中追踪功能的通知文本。
  - 更多详情，请参见[第二十三章 在Odoo中管理Email](https://alanhou.org/odoo-14-manage-emails-odoo/)。
  - 如果在模型中不使用_description，Odoo会在日志中输出一条警告。

- 默认Odoo使用内部id值（自动生成的主键）进行排序。

  - 但是，可对其进行修改来使用我们自己选择的字段排序，做法是提供一个包含字段名逗号分隔列表字符串的_order属性。
  - 字段名后可接desc关键字来进行降序排序。

  - 仅能使用存储在数据库中的字段。未存储的计算字段无法用于记录排序。

> 📝重要：仅可使用数据库中存储的字段。未存储的计算字段无法用于记录排序
>
> _order字符串的语法类似于SQL中的ORDER BY语句，但进行了简化。例如，不允许NULLS FIRST这样的特殊语句。

- 模型记录在其它记录中引用时使用了一种表现形式。
  - 例如，带有值1的user_id表示管理员用户。在表单视图中显示时，Odoo会显示用户名，而非数据库ID。
  - 简言之，`_rec_name`属性是在Odoo图形界面中用于展示该记录的记录显示名称。默认使用的是name字段。
  - 本例中，library.book模型有一个name字段，因此默认Odoo使用它作为显示名称。
  - 我们在第3步中对这一行为进行了修改，使用short_name作为_rec_name。
  - 之后，library.book模型的显示名称由name变为了short_name，Odoo GUI会使用short_name的值来展示记录。

> 📝警告：如果模型中没有name字段且未指定_rec_name，显示名称将是模型名称和记录ID的组合，如(library.book, 1)。

- 因为我们在模型中新增了short_name字段，Odoo ORM会在数据表中新增一列，但该字段不会在视图中显示。
- 要进行显示，我们需要在表单视图中添加该字段。在第4步中，我们在表单视图中添加了short_name。



##### 扩展知识…

- 记录表示可采用一个魔法计算字段**display_name**，从版本8.0起自动添加到了所有模型中。

  - 它的值由name_get() 模型方法生成，在Odoo此前的版本中已存在这一方法。

- name_get()的默认实现使用`_rec_name`属性来查找存放数据的字段，使用它生成显示名称。

- 如果想要自己实现显示名称，可以重载name_get()中的逻辑来生成一个自定义显示名称。

  - 该方法应返回一个包含两个元素的元组列表：记录ID和记录的Unicode字符串表示。

- 例如，在表示中包含标题和发行日期，类似Moby Dick (1851-10-18)，我们可以进行如下定义：

  - 看下如下示例。它会在记录名称中添加一个发布日期：

    ```python
    def name_get(self):
        result = []
        for record in self:
            rec_name = "%s (%s)" % (record.name, record.date_release)
            result.append((record.id, rec_name))
        return result
    ```

  - 添加如下代码后，就会更新display_name记录。

    - 假设有一条名为`Odoo Cookbook`、发行日期为`19-04-2019`的记录。

    - 那么上述的name_get()方法会生成一个`Odoo Cookbook (19-04-2019)`这样的名称。



##### 向模型添加数据字段

模型用于存储数据，数据按字段进行组织。这里，我们将学习到可存储在字段中的不同数据类型，以及如何在模型中进行添加。

##### 如何实现…

my_library插件模块应该已经有定义了基本模型的models/library_book.py文件，我们将编辑该文件来新增字段：

- 使用最小化语法来向图书模型添加字段

  ```python
  from odoo import models, fields
   
   
  class LibraryBook(models.Model):
      _name = 'library.book'
      _description = 'Library Book'
      _order = 'date_release desc, name'
      _rec_name = 'short_name'
  
      name = fields.Char('Title', required=True)
      short_name = fields.Char('Short Title',translate=True, index=True)
      notes = fields.Text('Internal Notes')
      state = fields.Selection(
          [('draft', 'Not Available'),
          ('available', 'Available'),
          ('lost', 'Lost')],
          'State', default="draft")
      description = fields.Html('Description', sanitize=True, strip_style=False)
      cover = fields.Binary('Book Cover')
      out_of_print = fields.Boolean('Out of Print?')
      date_release = fields.Date('Release Date')
      date_updated = fields.Datetime('Last Updated')
      pages = fields.Integer('Number of Pages',
          groups='base.group_user',
          states={'lost': [('readonly', True)]},
          help='Total book page count', company_dependent=False)
      reader_rating = fields.Float(
          'Reader Average Rating',
          digits=(14, 4), # Optional precision (total, decimals),
          )
      author_ids = fields.Many2many(
          'res.partner',
          string='Authors'
      )
  ```

- 我们已向模型新增了字段。仍需在表单视图中添加这些字段来在用户界面中反映出这些修改。参见如下在表单视图中增加字段的代码

  ```xml
  <form>
      <group>
          <group>
              <field name="name"/>
              <field name="author_ids" widget="many2many_tags"/>
              <field name="state"/>
              <field name="pages"/>
              <field name="notes"/>
          </group>
          <group>
              <field name="short_name"/>
              <field name="date_release"/>
              <field name="date_updated"/>
              <field name="cover" widget="image" class="oe_avatar"/>
              <field name="reader_rating"/>
          </group>
      </group>
      <group>
          <field name="description"/>
      </group>
  </form>
  ```

- 重启odoo服务

  - 升级模块会让Odoo模型中这些修改生效



##### 运行原理

通过在Python类中的定义属性向模型添加字段。可以使用的非关联字段类型如下：

- Char用于字符串值。

- Text用于多行字符串值。

- Selection用于选择列表。这是一个值和描述对的列表。所选择的值存储于数据库中，可以是字符串或整型。描述自动可翻译。

  > **📝重要贴士：**在Selection类型的字段中，可以使用整型的键，但应注意Odoo内部将0解释为未设置，不会显示存储值为0的描述。这可能会发生，所以应当铭记于心。

- Html类似于text字段，但通常用于以HTML格式存储的富文本。

- Binary字段存储二进制文件，如图像或文档。

- Boolean存储True/False 值。

- Date存储日期值。在数据库中以日期进行存储。ORM中以Python date对象的形式对其进行处理。可以使用fields.Date.today()在日期字段中将当前日期设置为默认值。Odoo 12之前的版本中ORM以字符串的形式处理日期。所使用的格式在odoo.fields.DATE_FORMAT中定义。

- Datetime用于日期时间值。在数据库中以原生UTC时间datetime进行存储。ORM中以Python datetime对象的形式对其进行处理。可以使用fields.Date.now()在日期时间字段中将当前时间设置为默认值。Odoo 12之前的版本中ORM以字符串的形式处理datetime。所使用的格式在odoo.fields.DATETIME_FORMAT中定义。

- Integer字段无需过多解释了。

- Float（浮点）字段存储数值。精度可由位数和小数位数对来定义。

- Monetary可存储某个币种的数量值。这会在本章中的*向模型添加货币字段*一节进行讲解。



本节的第一步中展示了添加各个字段类型的最小化语法。字段定义可像第2步中那样进行扩展来添加其它可选属性。

##### 以下是有关所使用的属性的讲解：

- string是字段的标题，在UI视图标签中使用。它是可选项，如未设置，会通过首字母大写及将空格替换为下划线来从字段名获取标签。

- translate，在设置为True时，让字段可翻译，它可根据用户界面的语言保存不同值。

- default是默认值。也可以是一个用于计算默认值的函数，例如default=_compute_default，其中_compute_default是在定义字段前模型中所定义的一个方法。

- help是在UI提示中显示的解释性文本。

- groups让字段仅对安全组可用。它是包含安全组XML ID逗号分隔列表的一个字符串。这个话题将会在[第十章 权限安全](https://alanhou.org/odoo-14-access-security/)中进行讨论。

- states允许用户界面依据state字段的值来动态设置readonly, required和invisible属性值。因此，它要求存在一个state字段并在表单视图中使用（即便是隐藏的）。state属性的名称是在Odoo硬编码且无法修改的。

- copy标记在复制记录时是否拷贝字段值。对于非关联型字段和Many2one字段它的默认值是True、对One2many和计算字段它的默认值是False。

- index，在设置为True时，为该字段创建一个数据库索引，有时可供更快速搜索使用。它取代了已弃用的select=1属性。

- readonly标记让该字段在用户界面中默认仅为只读。

- required标记强制字段在用户界面中默认为必填。

  > 📝这里所提到的各种白名单在odoo/tools/mail.py中进行定义。

- company_dependent标记让该字段按公司/租户存储不同值。它取代了已弃用的Property字段类型。

- group_operator 是一个用于按模式在组中显示结果的聚合函数。该属性的可用值有count、count_distinct、array_agg、bool_and、bool_or、max、min、avg和 sum。 整型、浮点型和monetary类型该属性的默认值是sum。

- sanitize标记用于HTML字段，提取不安全标签中的内容。使用它会对输入进行全局清理。



如果需要更细粒度的HTML清理控制，可以使用一些其它关键字，仅在启用sanitize时生效：

- sanitize_tags=True删除白名单列表以外的标签（默认项）
- sanitize_attributes=True删除白名单列表以外的标签属性
- sanitize_style=True删除白名单列表以外的样式属性
- strip_style=True删除所有样式元素
- strip_class=True删除所有class属性

最后，我们根据模型中新增的字段更新了表单视图，我们可以在任意位置以自己的方式放置`<field>`标签。表单视图在[第九章 后端视图](https://alanhou.org/odoo-14-backend-views/)中会进行细致的讲解。



##### 扩展知识

Selection字段还接收一个函数引用来代替列表作为selection属性。这允许动态生成选项列表，你会在本章的*使用引用字段添加动态关联*一节中看到一个示例，其中也使用了selection属性。

Date和Datetime字段对象暴露了一些非常方便的工具方法。



##### Date有如下方法：

- fields.Date.to_date(string_value)将字符串解析为一个date对象。
- fields.Date.to_string(date_value)将python Date对象转化为字符串。
- fields.Date.today()以字符串格式返回当天日期。这适合用于默认值。
- fields.Date.context_today(record, timestamp)根据记录（或记录集）上下文的时区以字符串格式返回时间戳对应的日期（或者在省略时间戳时返回当天日期）。



##### Datetime有如下方法：

- fields.Datetime.to_datetime(string_value)将字符串解析为datetime对象。
- fields.Datetime.to_string(datetime_value)将datetime对象转化为字符串。
- fields.Datetime.now()以字符串格式返回当天日期及当前时间。适合用作默认值。
- fields.Datetime.context_timestamp(record, timestamp)将时间戳原生datetime对象按照记录上下文的时区转化为对应时区。它不适合用作默认值，但是在向外部系统发送数据等操作时可以使用。



除基本字段外，我们还有关联字段：Many2one, One2many和Many2many。这些会在本章*向模型添加关联字段*一节中进行讲解。

字段也可以有动态计算的值，使用compute字段属性定义计算函数。这在*向模型添加计算字段*一节中进行讲解。



有些字段在Odoo模型中默认添加，因此我们**不应在字段中使用这些名称**。这些是记录自动生成的标识符的id字段以及一些审计日志字段，如下所示：

- create_date是记录创建的时间戳
- create_uid是创建该记录的用户
- write_date是最近记录的编辑时间戳
- write_uid是最后编辑记录的用户

这些日志字段的自动创建可通过设置模型属性**_log_access=False**来进行禁用。



另一个可以向模型添加的**特殊字段是active**。它应是布尔型字段，允许用户将记录标记为非活跃（inactive）。用于对记录启用存档/取消存档功能。它的定义如下：

```python
active = fields.Boolean('Active', default=True)
```

默认只有将active设置为True的记录才可见。要获取这些记录，我们需要使用域过滤器[(‘active’, ‘=’, False)]。而如果向环境上下文添加了’active_test’: False 值，ORM则不会过滤掉非活跃记录。

> **📝小贴士：**在有些情况下，可能无法修改上下文来获取活跃及非活跃记录。这时，可以使用[‘|’, (‘active’, ‘=’, True), (‘active’, ‘=’, False)] 域。
>
> **📝注意：**[(‘active’, ‘in’ (True, False))]可能不会如你所预期那样。Odoo在域中显式地查找(‘active’, ‘=’, False)语句。它默认会限制仅搜索活跃记录。





##### 使用可配置精度的浮点字段

在使用浮点字段时，我们可能会想让终端用户自己配置所使用的精度。本节中我们会对Library Books模型添加一个成本（Cost Price）字段，让用户可配置其小数精度。

执行如下步骤来对模型的cost_price字段应用动态小数点精度：

- 通过Settings菜单下的链接启用开发者模式（参见[第一章 安装Odoo开发环境](https://alanhou.org/odoo-14-installing-the-odoo-development-environment/)中的*激活Odoo开发者工具*一节）。这会启用Settings > Technical菜单。

- 访问数字精度设置。这需要打开Settings顶级菜单并选择Technical > Database Structure > Decimal Accuracy。我们应该会看到一个当前定义的设置列表。

- 添加一个新配置，设置Usage为Book Price并选择Digits精度：

  ![image-20230228095004210](/Users/pert/Library/Application Support/typora-user-images/image-20230228095004210.png)

- 要使用数字精度设置添加模型字段，编辑models/library_book.py文件并添加如下代码

  ```python
  cost_price = fields.Float('Book Cost', digits='Book Price')
  ```

  **📝小贴士：**不论何时向模型添加新字段，都需要将它们添加到视图中以在用户界面中访问。在前例中，我们添加了cost_price。要在表单视图中看到它，需要添加<field name="cost_price"/>。



##### 运行原理…

在向字段的digits属性中添加字符串值时，Odoo在小数精度模型的Usage字段中查找该字符串，返回一个16位精度的元组以及在配置中所定义的小数位数。使用字段定义来代替硬编码，可心让终端用户根据需求来自行配置。

> 📝**小贴士：**使用v13之前的版本，要求对浮点字段的digits属性做更多的配置工作。老版本中，小数精度位于一个单独的模块decimal_precision中。要在字段中启用自定义小数精度，需要像这样使用decimal_precision中的get_precision()方法：cost_price = fields.Float( ‘Book Cost’, digits=dp.get_precision(‘Book Price’))。



##### 向模型添加货币字段

货币字段需要一个补充的币种字段来存储相应货币金额。

- my_library中已经有了models/library_book.py并定义了一个基础模型。我们将编辑该文件来添加所需的字段：

  ```python
  currency_id = fields.Many2one(
          'res.currency', string='Currency')
  ```

- 添加货币字段来存储金额

  ```python
  retail_price = fields.Monetary(
          'Retail Price',
          # optional: currency_field='currency_id',
      )
  ```

- 现在升级这个插件模块，模型中即可使用新增字段了。未在视图添加时它们还不会在视图中显示，但通过Settings > Technical > Database Structure > Model查看模型字段(搜索library.book)可确定添加是否成功。在将它们添加到表单视图中之后，效果如下：

  ![image-20230228095312463](/Users/pert/Library/Application Support/typora-user-images/image-20230228095312463.png)

  

##### 运行原理…

货币字段与浮点字段类似，但因通过**第二个字段知道了币种**，Odoo可以在用户界面中进行正确的展示。

这个币种字段一般称为**currency_id**，但我们可以使用任意字段名，只要在currency_field可选参数中使用它即可。

> **📝小贴士：**如果以currency_id名称的字段存储币种信息可以在货币字段中省略掉currency_field属性。
>
> 在需要在同一记录中维护不同币种的金额时这会非常有用，例如，在我们想要包含销售订单的币种和公司的币种时。可以配置两个 fields.Many2one(res.currency) 字段并对第一个金额使用前一个字段、第二个金额使用第二个字段。

你还应知道金额的小数精度来自币种的定义（res.currency模型中的decimal_precision字段）。

