

##### odoo-bin后使用了如下命令行参数：

| 参数                                 | 解释                                                         |
| ------------------------------------ | ------------------------------------------------------------ |
| -d                                   | 默认使用这一数据库                                           |
| –db-filter=database_name$            | 仅尝试连接匹配所提供正则表达式的数据库。一个Odoo安装可以为使用不同数据库的多个实例提供服务，通过这一参数限制可用的数据库。最后的那个$很重要，因为在匹配模式中使用了正则表达式，这会避免选择以相同的指定字符串开头的名称。 |
| –addons-path=directory1,directory2,… | Odoo通过这一逗号分隔列表中的目录来查找插件（add-on）。在实例创建的时候扫描该列表来添加实例中可用的插件模块列表。如果希望使用Odoo企业版，请在这一选项中添加其目录。 |
| -i base:                             | 用于安装base模块。通过命令行创建数据库时需要使用到。         |

##### 如果你使用了与Linux当前登录用户不同的数据库用户，则需要再传递如下的参数：

| 参数                           | 解释                             |
| ------------------------------ | -------------------------------- |
| –db_host=localhost             | 使用TCP连接数据库服务            |
| –db_user=database_username     | 使用指定的数据库登录用户         |
| –db_password=database_password | 这是用于认证PostgreSQL服务的密码 |



##### 创建新库参数

- Master Password：这是这一实例的主控密码。
- Database Name：输入所想要创建的数据库名称。
- Email: 在此处添加email地址；在稍后用作用户名。
- Password：输入你想为新实例所设置的admin用户密码。
- Phone Number：设置电话号码（可选）。
- Language：在下拉列表中选择你希望新数据库默认安装的语言。Odoo会自动加载所选语言的翻译。
- Country：在下拉列表中选择主租户的国家。选择这一项后会自动做一些配置，如公司的币种。
- Demo data：勾选获取演示数据。这对于运行交互式测试或为用户设置演示项目非常有用，但针对包含生产数据的数据库设计时则不应勾选。

点击Continue按钮并等待新数据库初始化完成。然后会被重定向到该实例并以管理员进行连接。

##### 备份数据库

- 填写表单

  - Master Password：Odoo服务的主控密码。

  - Backup Format：对生产数据库请保持使用zip，因为这是唯一真正的全量备份格式。仅在备份不关心文件存储的开发数据库时使用pg_dump格式。

- 点击Backup。然后浏览器会下载备份文件。



**主控密码**是非常重要的信息，仅存储在Odoo服务的配置文件中，**从不在数据库中进行存储**。曾经有一个admin默认值，但使用这个值是一个广为人知的安全问题。在Odoo v9及之后的版本中，这被识别为一个未设置的主控密码，并在访问数据库管理页面时会敦促你修改密码。虽然这在配置文件中以admin_passwd进行存储，它与admin的密码是不同的，它们是两个不同的密码。主控密码是为Odoo服务进程设置的，进程本身可以处理多个数据库实例，每个实例都有一个独立的admin用户及其自己的密码。

> 📝安全考虑：记住本章中我们所考虑的是开发环境。Odoo数据库管理界面在我们运行生产服务时是需要进行安全保护的，因为这里给到了过多敏感信息的访问权限，尤其是在服务器托管了多个不同客户端的Odoo实例时。

Odoo使用PostgreSQL的createdb工具来新建数据库，它通过和以空数据库启动Odoo时相同的方式调用内部的Odoo函数来初始化新数据库。

Odoo使用createdb的–template选项传递原数据库作为参数来复制数据库。这基本上使用内部优化的PostgreSQL例行程序在新数据库中复制模板数据库的结构，这比创建备份和还原备份的速度会快很多（尤其是在使用网页界面时，还要求你下载备份文件然后再重新上传）。

备份和还原操作分别使用pg_dump和pg_restore工具。在使用zip格式时，备份还包含文件存储的拷贝，其中为配置Odoo不保存在数据库中的文档的拷贝，这是14.0中的默认选项。如果没做过修改的话，这些文件存放在~/.local/share/Odoo/filestore中。

> 📝如果备份很大，下载时会失败。这可能是因为Odoo服务本身无法在内存中处理这么大的文件或者是因为服务在反向代理之后运行，而这个代理设置了HTTP响应大小的限制。反过来，出于某些原因，你可能会在还原数据库的操作中遇到问题。在碰到这些问题时，应当投入时间建立更健壮的外部备份方案。





##### 删除一个实例：

```
dropdb dbname
```

##### 创建一个备份（假设PostgreSQL服务在本地运行）：

```
pg_dump -Fc -f sll.bak sll
```

##### 还原备份：

```
pg_restore -C -d dbname sll.bak
```

> 📝**当心！**
>
> 如果你的Odoo实例使用了另一个用户连接数据库，需要传递-U username来使用正确的用户作为还原数据库的所有者。



##### 在文件中存储实例配置

odoo-bin脚本有几十个选项，记住所有这些以及记得在启动服务时适当地进行配置会非常单调费力。所幸可以将它们存储在一个配置文件中，只需对想要修改的选项进行手动修改，比如为开发环境做修改。

##### 如何配置

- 运行如下命令来为你的Odoo实例生成一个配置文件：

  ```
  ./odoo-bin --save --config myodoo.cfg --stop-after-init
  ```

- 还可以添加其它选项，它们的值会被保存到所生成的文件中。所有未设置的值都会以默认值进行保存。使用如下命令来获取可用的选项列表：

  ```
  ./odoo-bin --help | less
  ```

  - 这会提供一些不同选项所执行内容的帮助文档。

- 要从命令行形式转化为配置形式，使用长选项名，删除前面的中间杠，并将中间的中间杠转换为下划线。`–without-demo`就变成了`without_demo`。对大多数选项都是如此，但有一些例外，在下一部分中会列出。

- 编辑myodoo.cfg文件（使用下一部分中的表格来查看所要修改的参数）。然后运行如下命令来以所保存的选项启动服务：

  ```
  ./odoo-bin -c myodoo.cfg
  ```

> 📝--config选项通常简写为-c。



#### 运行原理

启动时，Odoo通过三个步骤来加载它的配置。首先，所有选项的一组默认值会从源码中进行初始化，然后解析配置文件，**该文件中所定义的任意值会覆盖默认值。**最后，会分析命令行选项，它们的值会覆盖前面步骤中所获取的配置。

##### 通过配置文件设置的常用选项列表：

| 选项                       | 格式                 | 用途                                                         |
| :------------------------- | :------------------- | :----------------------------------------------------------- |
| without_demo               | 逗号分隔的模块名列表 | 该选项阻止模块演示数据被加载。 设置为all取消所有模块的演示数据，设为False为所有模块启用演示数据。对具体模块禁用演示数据，应提供模块名，如 sale,purchase,crm。 |
| addons_path                | 逗号分隔的路径列表   | 这是一个服务查找插件的路径名列表。                           |
| admin_passwd               | 文本                 | 这是 master 密码（参见前面部分的内容）                       |
| data_dir                   | 一个目录路径         | 这个目录中服务会存储session信息、从网上下载的插件以及在启用了文件存储时存放文档。 |
| http_interface             | 网络接口的 IP 地址   | 默认为0.0.0.0，表示服务监听所有接口。                        |
| http_port longpolling_port | 端口号               | 这些是 Odoo 服务所会监听的端口。你需要指定这两者来在同一台主机上运行多个 Odoo 服务；longpolling_port仅在workers不为0时使用。 http_port默认值为8069，longpolling_port默认为8072。 |
| logfile                    | 文件路径             | Odoo 写入日志的文件。                                        |
| log_level                  | 日志信息级别         | 指定日志的级别。可接受的值（内容逐渐增加）包括critical, error, warn, info, debug, debug_rpc, debug_rpc_answer, debug_sql。 |
| workers                    | 整数                 | worker进程的数量                                             |
| proxy_mode                 | True/False           | 激活反向代理WSGI封装。仅在运行于可信任的 web 代理后启用它。  |



##### 以下是与数据库相关的配置选项列表：

| 选项        | 格式           | 用途                                                         |
| :---------- | :------------- | :----------------------------------------------------------- |
| db_host     | 主机名         | 这是运行PostgreSQL服务的服务器名。使用 False 来使用本地 Unix 域套接字，以及 localhost 来使用本地 TCP 套接字。 |
| db_user     | 数据库登录用户 | 在db_host为 False 时这通常为空。这将是用于连接数据库的用户。 |
| db_password | 数据库用户密码 | 在db_host为 False以及 db_user 与运行服务的用户相同时通常为空。阅读pg_hba.conf的主页面来获取更多相关信息。 |
| db_name     | 数据库名       | 用于设置一些默认执行命令操作的数据库名。这不会限制服务所操作的数据库。参照下面的 dbfilter 参数。 |
| db_sslmode  | 数据库SSL模式  | 用于指定数据库SSL连接模式。                                  |
| dbfilter    | 一个正则表达式 | 该表达式应匹配服务所使用的数据库名。如果你运行网站，应该匹配单个数据库，类似^databasename$。 |
| list_db     | True/False     | 设置为 True 来取消列出数据库。                               |



##### 表中的pg_hba.conf文件位置：/etc/postgresql/xxx/main/pg_hba.conf

Odoo对配置文件的解析现在使用Python的ConfigParser模块。但是在Odoo 11.0中的实现发生了变化，它不再支持使用变量插值。因此，如果你习惯了使用`%(section.variable)s`表达式通过其它变量的值定义变量值的话，需要改变这一习惯并恢复使用显式的值。

有些选项不在配置文件使用，但广泛用于开发之中：

| 选项         | 格式                             | 用途                                                         |
| :----------- | :------------------------------- | :----------------------------------------------------------- |
| -i或--init   | 逗号分隔的模块名列表             | 它会在初始化数据库时默认安装给定的模块                       |
| -u 或-update | 逗号分隔的模块名列表             | 它会在重启服务时更新给定的模块。多在修改了源代码或从 git 更新了分支时使用 |
| --dev        | all, reload, qweb, werkzeug, xml | 这会启用开发者模式及自动重新加载功能。                       |





##### 激活Odoo开发者工具

例如，如果你的链接是http://localhost:8069/web#menu_id=102&action=94

- 在链接的#号前，插入?debug=1，那么你需要将其修改为http://localhost:8069/web?debug=1#menu_id=102&action=94。
- 使用带静态文件的调试模式，插入?debug=assets则将 URL修改为http://localhost:8069/web?debug=assets#menu_id=102&action=94
  - 加(with assets)的模式会将静态文件（css, js）分拆每一个具体文件，这将有助于调试，但相对于合并的静态文件而言会损失一些加载速度



##### 通过如下其中一种方式可退出开发者模式：

- 编辑URL并在查询字符串中写入?debug=1
- 通过使用Settings菜单相同位置下的Deactivate the developer mode链接
- 点击顶部调试小虫图标，在下拉菜单中点击Leave Developer Tools选项



##### 开发者模式中，会发生两件事情：

- 鼠标在表单视图的字段上或列表视图的列名上悬浮时会给出提示信息，提供该字段的技术信息（内部名称、类型等）。
- 调试图标下拉菜单会显示在右上角用户菜单旁，给到显示的模型相关技术信息的访问，有各种关联的视图定义、工作流、自定义过滤管理等等。

开发模式有一个变体：Developer mode (with assets)。这一模式和普通的开发者模式相似，但除此之外，发送到浏览器的JavaScript 和 CSS没有做最小化处理，这表示你浏览器的web开发者工具可以方便地用于调试JavaScript代码

> 📝**注意！**
>
> 使用非开发者模式及开发者模式来测试你的插件，因JavaScript库的非最小化版本会隐藏最小化版本中伤你至深的 bug。





##### 更新插件模块列表

在新增模块时，Odoo并不知道新模块的存在。为在Odoo中列出该模块，需要更新模块列表。

##### 准备工作

启动实例并使用Administrator账号连接实例。然后启用开发者模式

##### 如何实现…

在实例中更新已有的插件模块列表，执行如下步骤：

- 打开Apps菜单**。**

- 点击Update Apps List。更新应用列表的菜单项
  ![Odoo 14开发者指南第一章 安装Odoo开发环境](https://i.cdnl.ink/homepage/wp-content/uploads/2020/12/2020122606100382.jpg)

- 在弹出的对话框中点击Update按钮：更新应用列表对话框
  ![Odoo 14开发者指南第一章 安装Odoo开发环境](https://i.cdnl.ink/homepage/wp-content/uploads/2020/12/2020122606121927.jpg)

- 在更新结束时，可以点击Apps查看更新后的可用插件模块列表。需要删除掉Apps搜索框中默认的过滤器来查看所有模块。



##### 运行原理…

在点击Update按钮时，Odoo会读取插件路径配置变量。对于列表中的每个路径，它会查找插件声明文件包含的直接子目录，声明文件`__manifest__.py`存储在插件模块目录下。Odoo读取声明内容，查找其中的Python字典。只要声明中键为installable的实例不设置为False，就会将插件模块元数据存储到数据库中。如果模块已存在，会更新信息。如不存在，会新建一条记录。如果此前可用的插件模块查找不到，也不会从列表中进行删除。

> 📝仅在初始化数据库后新增插件路径时才需要更新应用列表。如果在初始化数据库之前在配置文件中新增了插件路径，则无需手动更新模块列表。

总结一下我们目前所学到的知识，在完成安装后，我们使用如下命令启动Odoo服务(如果使用了虚拟环境，需要先激活该环境)：

```
python3 odoo-bin -d odoo-test -i base --addons-path=addons --db-filter=odoo-test
```

运行后，可以通过http://localhost:8069来访问Odoo。

还可以使用配置文件来运行Odoo，如下：

```
./odoo-bin -c myodoo.cfg
```

启动好Odoo服务后，可以在Apps 菜单下安装/更新其中的模块。