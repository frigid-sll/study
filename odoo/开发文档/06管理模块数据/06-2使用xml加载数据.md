上一节中，我们使用外部标识符book_cookbook新建了一条图书记录。本节中，我们会通过XML文件来添加另一种类型的数据。我们添加一条书和作者的演示数据。还会添加在模块中添加知名出版社作为常规数据。

##### 如何实现…

按照如下步骤创建两个XML文件并在`__manifest__.py`文件中进行关联。

- 在你的声明文件中的demo版块中添加一个名为 data/demo.xml的文件：

  ```
  {
      'name': "My library",
      'summary': "轻松管理图书",
      'description': """
  Manage Library
  ==============
  Description related to library.
       """,
      'author': "Alan Hou",
      'website': "https://alanhou.org",
      'category': 'Uncategorized',
      'version': '14.0.1',
      'depends': ['base'],
      'data': [
          'security/groups.xml',
          'security/ir.model.access.csv',
          'views/library_book.xml',
          'views/library_book_categ.xml',
          'data/data.xml',
      ],
      'demo': [
          'data/demo.xml'
      ],
  }
  ```

- `data/demo.xml`在该文件中添加如下内容

  ```xml
  <?xml version="1.0" encoding="utf-8" ?>
  <odoo>
      <record id="base.main_company" model="res.company">
          <field name="name">Packt Publishing</field>
      </record>
  
      <record id="author_pga" model="res.partner">
          <field name="name">Parth Gajjar</field>
      </record>
      <record id="author_af" model="res.partner">
          <field name="name">Alexandre Fayolle</field>
      </record>
      <record id="author_dr" model="res.partner">
          <field name="name">Daniel Reis</field>
      </record>
      <record id="author_hb" model="res.partner">
          <field name="name">Holger Brunn</field>
      </record>
  
      <record id="book_cookbook" model="library.book">
          <field name="name">Odoo 14 Development Cookbook</field>
          <field name="short_name">cookbook</field>
          <field name="date_release">2020-12-24</field>
          <field name="author_ids" eval="[(6, 0, [ref('author_pga'), ref('author_af'), ref('author_dr'), ref('author_hb')])]"/>
          <field name="publisher_id" ref="res_partner_packt"/>
      </record>
  </odoo>
  ```

- 在data/data.xml 文件中加入如下 XML 内容：

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <odoo>
      <record id="res_partner_packt" model="res.partner">
          <field name="name">Packt Publishing</field>
          <field name="city">Birmingham</field>
          <field name="country_id" ref="base.uk"/>
      </record>
  </odoo>
  ```
  
  

此时若更新该模块，会看到我们所创建的出版社，并且如果像[第三章 创建Odoo插件模块](https://alanhou.org/odoo-14-creating-odoo-add-on-modules/)中所指出的那样启用了演示数据，还可以看到这本书以及其作者。



##### 运行原理…

XML数据文件使用`<record>`标签来创建数据表中一行。`<record>`标签有两个必填属性：id和model。对于 id 属性，参见*使用外部ID和命名空间*一节，model属性引用模型的_name属性。然后，使用`<field>`元素来填入数据库中列，这在你所命名的模型中定义。模型还决定哪些字段是必填的并且定义了默认值。在这种情况下，无需显式地给这些字段赋值。

有两种方式在模块的声明文件中注册XML文件。一种是通过data键，另一种是通过demo键。

- data键中的数据文件在**每次安装或更新模块时进行加载**。
- 而demo键中的XML文件仅在对数据库启用了演示数据时才会加载。



第1步中，我们使用了demo键在声明文件中注册了XML数据文件。因为使用的是demo键，XML文件仅在**对数据库启用了演示数据**时才会加载。

在第2步中，`<field>`元素可以在为标量值时可包含简单文本值。如果需要传递一个文件的内容（例如设置图片时），使用`<field>`元素的file属性并传递相对插件路径的文件名。

设置引用有两种方式。

- 最简单的一种是使用**ref属性**，可用于many2one字段，仅需包含所要引用记录的XML ID。
- 对于one2many和many2many字段，我们**需要使用eval属性**。这是一种通用目的属性，可用于运行Python代码来作为字段值使用



##### 例如使用strftime(‘%Y-01-01’)来填充date字段

- X2many中应使用三个元素元组列表，元组的第一个值决定所要采取的操作。

- 在eval属性内，我们可以访问一个名为**ref的函数**，它返回以**字符串传入的XML ID 对应的数据库ID**。

- 这让我们可以无需知道不同数据库中可能不同的原始 ID 即可引用记录，如下所示：

  - (2, id, False)：它会删除通过数据库 id 所关联的记录。元组的第三个元素被忽略。

  - (3, id, False)：它通过id取消记录的one2many字段关联。注意这个操作不会删除原记录，已有记录保持原样。元组的最后一个元素也被忽略。

  - (4, id, False)：它添加一个已有记录 id的关联，元组的最一个元素被忽略。这应该是最常使用到的，通常伴有ref函数来通过其XML ID来获取记录的数据库 ID。

  - (5, False, False)：它会切断所有关联，但仍保持所关联的记录的完整性。

  - (6, False, [id, …])：它会清除当前引用的记录来将它们替换为 ID 列表中包含的记录。元组的第二个元素被忽略。




第3和第4步同前两步，只是使用data键来取代了demo键。这表示每次安装或升级模块时都会加载这些XML文件。

> 📝**重要：**注意数据文件中的顺序很重要，并且数据文件中的记录仅能引用该文件之前列表中数据文件所定义的记录。这也是为什么需要保持查看模块是否在空数据库中安装，因为在开发过程中，会经常在各处添加记录，能够使用的前提是后续所定义记录通过前几次更新已存在于数据库中。
>
> 演示数据总是会通过data键文件之后进行载入，这也是本例中的引用可以生效的原因。



##### 扩展知识…

虽然基本上你可以对记录元素做任何操作，开发人员可以使用一些快捷元素来便捷地创建某种类型的记录。这包含菜单项、模板和动作窗口。参见[第九章 后端视图](https://alanhou.org/odoo-14-backend-views/)和[第十四章 CMS网站开发](https://alanhou.org/odoo-14-cms-website-development/)来获取更多相关信息。

字段元素还可以包含function元素，它调用模型中的方法来提供字段值。参见*在XML文件中调用函数*一节，其中我们仅通过调用函数来在应用中直接绕过加载机制并写入数据库，

前述列表中没有包含0和1，因为在载入数据时这两者并没有什么用处。为保持完整性，说明如下：

- (0, False, {‘key’: value})：它会新建所引用模型的记录，字段值由第3个位置参数的字典填写。元组的第二个元素被忽略。因为这些记录不包含XML ID并在每次更新模块时运行，会导致重复数据，最好避免使用。取代方案是在其自身记录元素中创建记录，并按照*如何实现*一节讲解的进行关联。
- (1, id, {‘key’: value})：它可用于写入已关联的记录。由于上述的同样原因，应避免在XML文件中使用这种语法。

这些语法与我们在[第五章 基本服务端开发](https://alanhou.org/odoo-14-basic-server-side-development/)*新建记录*和*更新记录集中记录值*小节中所讲解的相同。