##### 使用CSV文件加载数据

虽然可以通过XML文件来进行所需任意操作，但在提供大量数据时这种格式并不是最方便的，尤其是现在很多人都习惯于使用Calc或其它数据表软件处理数据。CSV格式的另一个优势在于它是使用标准导出函数导出的数据格式。本节中，我们来学习导入表格类数据。



##### 如何实现…

最初，访问控制列表（ACL，参见[第十章 权限安全](https://alanhou.org/odoo-14-access-security/)）是一种通过CSV文件加载的数据。

- 在数据文件中添加security/ir.model.access.csv：

  ```
  'data': [
    ...
    'security/ir.model.access.csv',
   ],
  ```

- 在这个文件中添加我们图书的ACL（我们已经通过[第三章 创建Odoo插件模块](https://alanhou.org/odoo-14-creating-odoo-add-on-modules/)中*添加访问权限*一节添加了一些记录）

  ```
  id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
  acl_library_book_user,ACL for books,model_library_book,base.group_user,1,0,0,0
  ```

- 现在我们有了一个ACL，它允许普通用户读取图书记录，但无法编辑、创建或删除这些记录。



##### 运行原理…

仅需将所有数据文件放到声明文件的数据列表中。Odoo会通过文件扩展名来确定其文件类型。CSV文件的一个特别之处在于它必须匹配所导入的模型名称，本例中，该模型为 ir.model.access。第一行应为精确匹配模型字段名称的列名的头部。

对于标量值，可以使用带引号（如需要，因字符串自身包含引号或逗号）或不带引号的字符串。

在通过CSV文件编写many2one字段时，Odoo首先尝试将字段值解释为XML ID。如无点号，Odoo会将当前模块名添加为命名空间，并在 ir.model.data中查找结果。如若失败，会使用字段值来作为参数调用模型的name_search函数，获取第一条返回的结果。如依然失败，该行被视为无效，Odoo抛出错误。

> 📝**重要：**注意从CSV中所读取的数据保持为noupdate=False，并且没有快捷的修改方式。这表示所有后续的插件更新会一直重写由用户所做的修改。
>
> 如果需要加载大量的数据并且noupdate对你来说不是问题，可以在init钩子中加载CSV文件。



##### 扩展知识…

也可通过CSV文件来导入one2many和many2many字段，但会有些麻烦。通常，最好是分别创建记录然后在XML文件中设置关联，或者通过另一个CSV文件来设置关联。

如果确需在同一个文件中创建关联记录，对数据列进行排序来让标量字段居左、关联模型字段居右，列头包含待关联字段名及所关联的模型字段，由冒号分隔：

```
"id","name","model_id:id","perm_read","perm_read", "group_id:name"
"access_library_book_user","ACL for books","model_library_book",1, "my group"
```

这会创建一个名为my group的组，可以通过在组记录的右侧添加列来写入更多的字段。如果需要关联多条记录，重复该行并修改右侧列为对应值。因Odoo会为空列填写前一行的值，所以无需拷贝所有数据，添加一行时，对想要填充值的关联模型字段以外的字段只需使用空值。

对于x2m字段，只需要列出要关联记录的XML ID。