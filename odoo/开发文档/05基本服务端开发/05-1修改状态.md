##### 定义模型方法及使用API装饰器

Odoo模型中，类是字段定义和业务逻辑方法的混合体。

如何编写可由用户界面中按钮或应用其它代码块调用的方法。这一方法会操作图书并执行所需的动作来修改所选图书的状态。

##### 模型

```python
from odoo import models, fields, api
class LibraryBook(models.Model):
     # [...]
     state = fields.Selection([
         ('draft', 'Unavailable'),
         ('available', 'Available'),
         ('borrowed', 'Borrowed'),
         ('lost', 'Lost')],
         'State', default="draft")
```



要定义方法来修改所选图书的状态，你需要在模型定义中添加如下代码：

- 添加一个帮助方法来查看是否允许状态转换：

  ```python
  @api.model
  def is_allowed_transition(self, old_state, new_state):
       allowed = [('draft', 'available'),
           ('available', 'borrowed'),
           ('borrowed', 'available'),
           ('available', 'lost'),
           ('borrowed', 'lost'),
           ('lost', 'available')]
       return (old_state, new_state) in allowed
  ```

- 添加方法来修改一些书籍的状态为所传参数的新状态：

  ```python
  def change_state(self, new_state):
    	 print(self[0].name)
       for book in self:
           if book.is_allowed_transition(book.state, new_state):
              book.state = new_state
           else:
              continue
  ```

- 添加方法来通过调用change_state方法修改图书状态：

  ```python
  def make_available(self):
      self.change_state('available')
   
  def make_borrowed(self):
      self.change_state('borrowed')
   
  def make_lost(self):
      self.change_state('lost')
  ```

- 在`<form>`视图中添加按钮和状态栏。这会帮助我们从用户界面中触发这些方法：

  ```xml
  <form>
  ...
      <header>
          <button name="make_available" string="Make Available" type="object"/>
          <button name="make_borrowed" string="Make Borrowed" type="object"/>
          <button name="make_lost" string="Make Lost" type="object"/>
          <field name="state" widget="statusbar"/>
      </header>
  ...
  </form>
  ```

- 更新或安装该模块来让这些修改生效。



##### 运行原理

- 在第1步中，我们创建了**is_allowed_transition()** 方法。
  - 这个方法的目的是验证从一个状态到另一个状态的转换是否有效。
  - allowed列表中的元组即为可使用转换。例如，我们不会允许lost到borrow的转换，因此没有加入**(‘lost, ‘borrowed’)**。
- 第2步中，我们创建了 **change_state()**方法，这个方法的用途是修改图书的状态。
  - 调用该方法时，它将图书的状态修改为给定new_state参数的状态。
  - 仅在允许进行转换时它才会修改图书状态。这里使用了for循环是因为self可以 包含多个记录集。（是个序列集）
- 在第3步中，我们创建了一些通过调用**change_state()**方法来修改图书状态的方法。
  - 本例中，方法会由添加到用户界面中的按钮所触发。
- 第4步中，我们添加在`<form>`视图中添加了`<button>`。点击这一按钮时，Odoo客户端会触发name属性中所包含的Python函数。
  - 参见[第九章 后端视图](https://alanhou.org/odoo-14-backend-views/)中*向表单添加按钮*一节来学习如何从用户界面中调用该方法。
  - 我们还添加了带有statusbar组件的state字段，来在`<form>`视图中显示图书的状态。



在用户从用户界面中点击按钮时，会调用第3步中某个方法。

这里的self是一个包含library.book模型记录的记录集（可能为空）。然后，我们调用了 change_state()方法并根据所点击按钮传递相应的参数。

在调用change_state() 时，self是library.book模型中的相同数据集。

change_state()方法中的内容体对self进行循环来处理记录集中的每一本书。循环self一开始看上去很奇怪，这但快你就会习惯这种模式。

在循环中，change_state() 调用is_allowed_transition()。

调用通过本地变量book进行，但也可对library.book模型中的任意记录集进行调用

例如self，因为is_allowed_transition()由@api.model所装饰。如果允许转换，change_state()通过对记录集的属性赋值来为书籍分配一个新的状态。

这仅在**记录集长度为1**时有效，用于确保和遍历self的情况一致。



![Odoo 14开发者指南第五章 基本服务端开发](https://i.cdnl.ink/homepage/wp-content/uploads/2021/01/2021010510132712.jpg)

